# Bootstrap SSH trust chain tasks
- name: Ensure local controller RSA public key exists
  stat:
    path: "{{ lookup('env','HOME') }}/.ssh/id_rsa.pub"
  register: local_rsa_pub
  delegate_to: localhost

- name: Generate local RSA key (id_rsa) if missing
  command: ssh-keygen -t rsa -b 4096 -N '' -f "{{ lookup('env','HOME') }}/.ssh/id_rsa"
  when: not local_rsa_pub.stat.exists
  delegate_to: localhost
  register: gen_local_rsa
  changed_when: gen_local_rsa.rc == 0

- name: Read local RSA public key content
  slurp:
    src: "{{ lookup('env','HOME') }}/.ssh/id_rsa.pub"
  register: local_rsa_pub_content
  delegate_to: localhost

- name: Set fact for controller public key
  set_fact:
    controller_pubkey: "{{ local_rsa_pub_content.content | b64decode | trim }}"

- name: Install controller public key on host
  authorized_key:
    user: "{{ hostvars['host']['ansible_user'] | default('root') }}"
    key: "{{ controller_pubkey }}"
    state: present
  delegate_to: host

- name: Install controller public key on lp
  authorized_key:
    user: "{{ hostvars['lp']['ansible_user'] | default('root') }}"
    key: "{{ controller_pubkey }}"
    state: present
  delegate_to: lp

- name: Initialize host key trust chain
  block:
    - name: Remove stale known_hosts entries (optional)
      shell: ssh-keygen -R {{ item }} || true
      loop: ["{{ lp_host }}", "{{ imc_host }}", "{{ acc_host }}"]
      when: reset_known_hosts | bool
      changed_when: false

    - name: Wait for LP SSH port
      wait_for:
        host: "{{ lp_host }}"
        port: 22
        timeout: 120
        sleep: 5
      changed_when: false

    - name: Prime LP host key acceptance
      shell: ssh -o BatchMode=yes -o StrictHostKeyChecking=no {{ lp_user }}@{{ lp_host }} 'true'
      register: lp_key_accept
      changed_when: false
      retries: 5
      delay: 5
      until: lp_key_accept.rc == 0

    - name: Prime IMC host key via LP
      shell: >-
        ssh -o BatchMode=yes -o StrictHostKeyChecking=no
        -J {{ lp_user }}@{{ lp_host }}
        {{ imc_user }}@{{ imc_host }} 'true'
      register: imc_key_accept
      changed_when: false
      retries: 12
      delay: 5
      until: imc_key_accept.rc == 0

    - name: Attempt initial ACC host key prime (non-fatal)
      shell: >-
        ssh -o BatchMode=yes -o StrictHostKeyChecking=no
        -J {{ lp_user }}@{{ lp_host }},{{ imc_user }}@{{ imc_host }}
        {{ acc_user }}@{{ acc_host }} 'true'
      register: acc_key_accept
      changed_when: false
      failed_when: false

    - name: Host key priming summary
      debug:
        msg:
          - "LP prime rc={{ lp_key_accept.rc }}"
          - "IMC prime rc={{ imc_key_accept.rc }}"
          - "ACC initial prime rc={{ acc_key_accept.rc }}"