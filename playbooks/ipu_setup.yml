---
- name: IPU Setup - Verify Connectivity
  hosts: all_targets
  gather_facts: yes
  tasks:
    - name: Ping all hosts
      ansible.builtin.ping:

- name: Stop idpf driver on host
  hosts: host
  gather_facts: no
  tasks:
    - name: Remove idpf kernel module if loaded
      shell: if lsmod | grep -qw idpf; then rmmod idpf; fi
      ignore_errors: yes

- name: Download images on lp
  hosts: lp
  vars_files:
    - "../group_vars/vault.yml"
    - "../group_vars/all.yml"
  tasks:
    - name: Ensure temp folder exists on lp
      file:
        path: "/tmp"
        state: directory
        mode: "0777"

    - name: Set image URLs and paths dynamically
      set_fact:
        saiserver_url: "{{ artifactory_base_url }}/{{ release_type }}/{{ build_release }}/{{ saiserver_image_name }}"
        imc_config_url: "{{ artifactory_base_url }}/{{ release_type }}/{{ build_release }}/{{ imc_config_image_name }}"
        saiserver_lp: "/tmp/saiserver.tgz"
        imc_config_lp: "/tmp/imc-config.tgz"

    - name: Download saiserver image tarball on lp
      get_url:
        url: "{{ saiserver_url }}"
        dest: "{{ saiserver_lp }}"
        url_username: "{{ ci_user }}"
        url_password: "{{ ci_token }}"

    - name: Download imc-config tarball on lp
      get_url:
        url: "{{ imc_config_url }}"
        dest: "{{ imc_config_lp }}"
        url_username: "{{ ci_user }}"
        url_password: "{{ ci_token }}"

- name: Distribute images to imc via SCP from lp
  hosts: imc
  tasks:
    - name: Copy saiserver image from lp to imc using scp
      shell: scp -o StrictHostKeyChecking=no /tmp/saiserver.tgz root@{{ inventory_hostname }}:/tmp/saiserver.tgz
      delegate_to: lp

    - name: Copy imc-config image from lp to imc using scp
      shell: scp -o StrictHostKeyChecking=no /tmp/imc-config.tgz root@{{ inventory_hostname }}:/tmp/imc-config.tgz
      delegate_to: lp

    - name: Extract saiserver.tgz on imc
      unarchive:
        src: "/tmp/saiserver.tgz"
        dest: "{{ ansible_env.HOME }}"
        remote_src: yes

    - name: Extract imc-config tarball on imc
      unarchive:
        src: "/tmp/imc-config.tgz"
        dest: "/"
        remote_src: yes

    - name: Copy dash.pkg to /work/scripts/p4_custom.pkg
      copy:
        src: "{{ ansible_env.HOME }}/share/dash/dash.pkg"
        dest: "/work/scripts/p4_custom.pkg"
        remote_src: yes

    - name: Calculate md5sum for /work/scripts/p4_custom.pkg
      command: md5sum /work/scripts/p4_custom.pkg
      register: imc_pkg_md5

    - name: Show dash.pkg md5sum
      debug:
        var: imc_pkg_md5.stdout

    - name: Remove previous pkg directory on acc (via imc)
      shell: rm -rf /opt/p4/p4sde/share/dash
      delegate_to: acc

    - name: Copy saiserver image to acc (via imc)
      shell: scp -o StrictHostKeyChecking=no /tmp/saiserver.tgz root@{{ hostvars['acc']['ansible_host'] }}:/tmp/saiserver.tgz
      delegate_to: imc

    - name: Extract saiserver image on acc (via imc)
      unarchive:
        src: "/tmp/saiserver.tgz"
        dest: "/opt/p4/p4sde"
        remote_src: yes
      delegate_to: acc

    - name: Pause for manual editing before reboot of imc
      pause:
        minutes: 5
        prompt: "You may edit files on IMC now. Continue to reboot after editing."
